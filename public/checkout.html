<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Checkout - Charlie's Dropship</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 20px;
    }
    .card {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }
    .item-info { flex: 1; }
    .qty-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .qty-btn {
      background: #0ea5a4;
      color: #fff;
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }
    .quantity {
      min-width: 24px;
      text-align: center;
      font-weight: bold;
    }
    .remove-btn {
      background: #ef4444;
      color: #fff;
      padding: 4px 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .cart-btn {
      background: #0ea5a4;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      font-size: 16px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      margin: 6px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    h2, h3 {
      margin-top: 0;
    }
    .summary-row {
      display:flex;
      justify-content:space-between;
      margin: 6px 0;
    }
    .summary-row strong { font-weight: bold; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Checkout</h2>

    <!-- Cart Items -->
    <div id="cartList"></div>
    <div class="summary-row">
      <span>Subtotal</span><span id="cartSubtotal">₦0.00</span>
    </div>
    <div class="summary-row">
      <span>Shipping Fee</span><span id="shippingFee">₦0.00</span>
    </div>
    <div class="summary-row" style="font-weight:bold;font-size:16px;">
      <span>Total</span><span id="cartTotal">₦0.00</span>
    </div>

    <!-- Customer Details -->
    <h3>Your Details</h3>
    <form id="checkoutForm">
      <input id="custName" placeholder="Full Name" required>
      <input id="custEmail" type="email" placeholder="Email" required>
      <input id="custPhone" type="tel" placeholder="Phone Number" pattern="[0-9+ ]{6,}" required>
      <input id="custStreet" placeholder="Street Address">
      <input id="custCity" placeholder="City" required>

      <!-- Nigerian States -->
      <select id="custState" required>
        <option value="">Select State</option>
        <option value="Lagos">Lagos</option>
        <option value="Abuja">Abuja (FCT)</option>
        <option value="Kano">Kano</option>
        <option value="Rivers">Rivers</option>
        <option value="Oyo">Oyo</option>
        <option value="Enugu">Enugu</option>
        <option value="Anambra">Anambra</option>
        <option value="Delta">Delta</option>
        <option value="Kaduna">Kaduna</option>
        <option value="Edo">Edo</option>
        <!-- Add more states as needed -->
      </select>

      <input id="custPostal" placeholder="Postal Code">
      <select id="custCountry" required>
        <option value="NG" selected>Nigeria</option>
      </select>

      <!-- Payment Button -->
      <button id="checkoutPaystack" type="submit" class="cart-btn">
        Pay with Paystack
      </button>
    </form>
  </div>

<script>
const API = '/api';
let cart = JSON.parse(localStorage.getItem('ds_cart') || '[]');

const cartList = document.getElementById('cartList');
const cartSubtotal = document.getElementById('cartSubtotal');
const shippingFeeEl = document.getElementById('shippingFee');
const cartTotal = document.getElementById('cartTotal');
const stateSelect = document.getElementById('custState');

// Shipping fees per state (example values in Naira)
const shippingFees = {
  "Lagos": 2000,
  "Abuja": 2500,
  "Kano": 3000,
  "Rivers": 2800,
  "Oyo": 2200,
  "Enugu": 2500,
  "Anambra": 2400,
  "Delta": 2300,
  "Kaduna": 2700,
  "Edo": 2100
};

let subtotal = 0;
let shipping = 0;

// Format price depending on currency
function formatPrice(amount, currency="NGN") {
  return amount.toLocaleString("en-NG", { style: "currency", currency: "NGN" });
}

function saveCart() {
  localStorage.setItem('ds_cart', JSON.stringify(cart));
  renderCart();
}

function changeQuantity(idx, delta) {
  cart[idx].quantity += delta;
  if (cart[idx].quantity <= 0) {
    cart.splice(idx, 1);
  }
  saveCart();
}

function renderCart() {
  cartList.innerHTML = '';
  subtotal = 0;

  cart.forEach((item, idx) => {
    subtotal += item.price * item.quantity;
    const row = document.createElement('div');
    row.className = 'cart-item';
    row.innerHTML = `
      <div class="item-info">
        <strong>${item.title}</strong>
        <div class="qty-controls">
          <button class="qty-btn" onclick="changeQuantity(${idx}, -1)">−</button>
          <span class="quantity">${item.quantity}</span>
          <button class="qty-btn" onclick="changeQuantity(${idx}, 1)">+</button>
        </div>
      </div>
      <div>
        ${formatPrice(item.price * item.quantity)}
        <button class="remove-btn" onclick="changeQuantity(${idx}, -${item.quantity})">x</button>
      </div>`;
    cartList.appendChild(row);
  });

  updateTotals();
}

function updateTotals() {
  const selectedState = stateSelect.value;
  shipping = shippingFees[selectedState] || 0;

  cartSubtotal.textContent = formatPrice(subtotal);
  shippingFeeEl.textContent = formatPrice(shipping);
  cartTotal.textContent = formatPrice(subtotal + shipping);
}

stateSelect.addEventListener('change', updateTotals);

renderCart();

// Handle Paystack Checkout
const form = document.getElementById("checkoutForm");

form.onsubmit = async (e) => {
  e.preventDefault(); // stop default submit

  if (cart.length === 0) { 
    alert("Cart is empty"); 
    return; 
  }

  const customer = {
    name: custName.value.trim(),
    email: custEmail.value.trim(),
    phone: custPhone.value.trim(),
    street: custStreet.value.trim(),
    city: custCity.value.trim(),
    state: custState.value,
    postal: custPostal.value.trim(),
    country: custCountry.value
  };

  // Extra check for empty fields
  for (let key in customer) {
    if (!customer[key]) {
      alert("Please fill in all fields.");
      return;
    }
  }

  // Send order to backend (include shipping fee)
  const res = await fetch(`${API}/create-paystack-order`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ cartItems: cart, customer, shippingFee: shipping })
  });

  const data = await res.json();
  if (data.success && data.authorizationUrl) {
    window.location.href = data.authorizationUrl;
  } else {
    alert("Paystack error: " + (data.error || "Unknown error"));
  }
};
</script>
</body>
</html>
