<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Charlie's Store</title>
<meta name="title" content="Charlie's Store">
<meta name="description" content="Shop authentic products at Charlie's Store">
<meta property="og:type" content="website">
<meta property="og:url" content="https://watchme-c9eh.onrender.com/">
<meta property="og:title" content="Charlie's Store">
<meta property="og:description" content="Shop authentic products at Charlie's Store">
<meta property="og:image" content="https://watchme-c9eh.onrender.com/favico.png">
<link rel="icon" type="image/png" href="/favico.png" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --accent: #0ea5a4;
  --accent-light: #14b8b7;
  --danger: #ef4444;
  --danger-light: #f87171;
  --muted: #6b7280;
  --bg: #f8fafc;
  --card: #ffffff;
  --border: #e5e7eb;
  --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --gradient-accent: linear-gradient(135deg, #0ea5a4 0%, #14b8b7 100%);
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
}

* { box-sizing: border-box; }

body {
  font-family: "Plus Jakarta Sans", system-ui, Arial, sans-serif;
  margin: 0;
  background: linear-gradient(135deg, #667eea15 0%, #764ba215 50%, #f5576c15 100%);
  color: #1f2937;
  line-height: 1.6;
  min-height: 100vh;
}

/* Animated background */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(245, 87, 108, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(14, 165, 164, 0.05) 0%, transparent 50%);
  animation: bgShift 20s ease infinite;
  pointer-events: none;
  z-index: -1;
}

@keyframes bgShift {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.1); }
}

/* Header */
header {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(20px);
  padding: 16px 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.brand {
  font-weight: 800;
  font-size: 24px;
  background: var(--gradient-accent);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.cart-summary {
  text-decoration: none;
  color: inherit;
  font-weight: 600;
  padding: 10px 18px;
  background: var(--gradient-accent);
  color: white;
  border-radius: 12px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(14, 165, 164, 0.3);
}

.cart-summary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(14, 165, 164, 0.4);
}

#toggleCurrency {
  padding: 10px 18px;
  background: white;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

#toggleCurrency:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* Main Container */
.main {
  max-width: 1280px;
  margin: 32px auto;
  padding: 0 20px;
}

h2 {
  font-size: 32px;
  margin: 24px 0;
  font-weight: 800;
  color: #1f2937;
  letter-spacing: -0.5px;
  position: relative;
  display: inline-block;
}

h2::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 60px;
  height: 4px;
  background: var(--gradient-accent);
  border-radius: 2px;
}

/* Product Grid */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 24px;
  margin-top: 32px;
}

.card {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  padding: 16px;
  border-radius: 20px;
  box-shadow: var(--shadow-md);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  border: 1px solid rgba(255, 255, 255, 0.5);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-accent);
  transform: scaleX(0);
  transition: transform 0.3s ease;
}

.card:hover::before {
  transform: scaleX(1);
}

.card:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-lg);
}

.card img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 14px;
  margin-bottom: 12px;
  transition: transform 0.3s ease;
}

.card:hover img {
  transform: scale(1.05);
}

.card h4 {
  margin: 0 0 6px;
  font-size: 16px;
  font-weight: 700;
  color: #1f2937;
  line-height: 1.3;
}

.small {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}

.price {
  font-weight: 800;
  font-size: 20px;
  margin: 8px 0;
  background: var(--gradient-accent);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.actions {
  margin-top: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.qty-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--muted);
  font-weight: 600;
}

.qty-input {
  width: 60px;
  padding: 6px 10px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  text-align: center;
  font-weight: 600;
  transition: all 0.2s ease;
}

.qty-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.1);
}

.btns {
  display: flex;
  gap: 10px;
}

.cart-btn {
  flex: 1;
  background: var(--gradient-accent);
  color: white;
  border: none;
  padding: 10px 12px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 700;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(14, 165, 164, 0.3);
}

.cart-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(14, 165, 164, 0.4);
}

.cart-btn:active {
  transform: translateY(0);
}

.cart-btn.buy {
  background: var(--gradient-2);
  box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
}

.cart-btn.buy:hover {
  box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
}

/* Mobile Slider */
.rows-wrapper {
  display: none;
}

.row-container {
  position: relative;
  margin-bottom: 24px;
}

.row-slider {
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.row-slider::-webkit-scrollbar {
  display: none;
}

.grid-row {
  display: flex;
  gap: 16px;
  padding: 0 50px;
}

.grid-row .card {
  flex: 0 0 85%;
  max-width: 320px;
  scroll-snap-align: start;
}

.slider-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  color: var(--accent);
  border: 2px solid var(--border);
  border-radius: 50%;
  width: 44px;
  height: 44px;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  z-index: 10;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: center;
  justify-content: center;
}

.slider-arrow:hover {
  background: var(--accent);
  color: white;
  transform: translateY(-50%) scale(1.1);
}

.slider-arrow.left { left: 8px; }
.slider-arrow.right { right: 8px; }

/* Admin Panel */
.admin-panel {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  padding: 24px;
  margin-bottom: 32px;
  border-radius: 20px;
  box-shadow: var(--shadow-lg);
  display: none;
  border: 1px solid rgba(255, 255, 255, 0.5);
}

.admin-panel h3 {
  margin-top: 0;
  font-size: 20px;
  font-weight: 700;
  color: #1f2937;
}

.admin-tabs {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.admin-tabs button {
  padding: 10px 20px;
  border: 2px solid var(--border);
  border-radius: 12px;
  background: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.admin-tabs button.active {
  background: var(--gradient-accent);
  color: white;
  border-color: transparent;
  box-shadow: 0 4px 12px rgba(14, 165, 164, 0.3);
}

.admin-tabs button:not(.active):hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

#ordersTable, #productsTable {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 13px;
  border-radius: 12px;
  overflow: hidden;
}

#ordersTable th, #ordersTable td, #productsTable th, #productsTable td {
  border: 1px solid var(--border);
  padding: 12px;
  text-align: left;
}

#ordersTable th, #productsTable th {
  background: var(--gradient-accent);
  color: white;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 11px;
  letter-spacing: 0.5px;
}

#ordersTable tbody tr:hover, #productsTable tbody tr:hover {
  background: rgba(14, 165, 164, 0.05);
}

/* Fixed Buttons */
#adminAccessBtn, #whatsappBtn {
  position: fixed;
  bottom: 24px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  font-size: 24px;
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

#adminAccessBtn {
  right: 24px;
  background: var(--gradient-1);
  color: white;
}

#whatsappBtn {
  right: 96px;
  background: linear-gradient(135deg, #25D366 0%, #1ea952 100%);
  color: white;
}

#adminAccessBtn:hover, #whatsappBtn:hover {
  transform: scale(1.1) rotate(5deg);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
}

label {
  display: block;
  margin: 12px 0;
  font-size: 14px;
  font-weight: 600;
  color: #374151;
}

label input {
  margin-top: 6px;
  width: 100%;
  padding: 10px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  transition: all 0.2s ease;
}

label input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(14, 165, 164, 0.1);
}

#addProductBtn, #downloadCSV {
  margin-top: 16px;
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
}

#addProductBtn {
  background: var(--gradient-accent);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(14, 165, 164, 0.3);
}

#downloadCSV {
  background: var(--gradient-1);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

#addProductBtn:hover, #downloadCSV:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(14, 165, 164, 0.4);
}

/* Mobile Responsive */
@media (max-width: 600px) {
  .grid { display: none; }
  .rows-wrapper { display: flex; flex-direction: column; gap: 24px; }
  
  header { padding: 12px 16px; }
  .brand { font-size: 20px; }
  
  .header-right {
    gap: 10px;
  }
  
  .cart-summary, #toggleCurrency {
    padding: 8px 14px;
    font-size: 13px;
  }
  
  h2 { font-size: 26px; }
  
  #adminAccessBtn, #whatsappBtn {
    width: 50px;
    height: 50px;
    font-size: 20px;
    bottom: 16px;
  }
  
  #adminAccessBtn { right: 16px; }
  #whatsappBtn { right: 76px; }
}

@media (max-width: 400px) {
  #toggleCurrency span { display: none; }
  #toggleCurrency::after { content: 'üí±'; }
}

/* Loading animation */
@keyframes shimmer {
  0% { background-position: -1000px 0; }
  100% { background-position: 1000px 0; }
}

.loading {
  animation: shimmer 2s infinite;
  background: linear-gradient(to right, #f0f0f0 4%, #e0e0e0 25%, #f0f0f0 36%);
  background-size: 1000px 100%;
}
</style>
</head>
<body>

<header>
  <div class="brand">Charlie's Store</div>
  <div class="header-right">
    <a href="cart.html" class="cart-summary">
      üõí <span id="cartCount">0</span>
    </a>
    <button id="toggleCurrency"><span>Switch Currency</span></button>
  </div>
</header>

<button id="adminAccessBtn" title="Admin Panel">‚öôÔ∏è</button>
<button id="whatsappBtn" title="Chat with Dealer">üí¨</button>

<div class="main">
  <!-- Admin Panel -->
  <div class="admin-panel" id="adminPanelWrapper">
    <div class="admin-tabs">
      <button id="tabAddProduct" class="active">Add Product</button>
      <button id="tabManage">Manage Products</button>
      <button id="tabOrders">Orders</button>
    </div>

    <!-- Add Product -->
    <div id="addProductSection">
      <h3>Add Product</h3>
      <label>Title <input id="adminTitle"></label>
      <label>Price ($) <input id="adminPrice" type="number" step="0.01"></label>
      <label>Supplier Cost ($) <input id="adminCost" type="number" step="0.01"></label>
      <label>SKU <input id="adminSKU"></label>
      <label>Image URL <input id="adminImg"></label>
      <button id="addProductBtn">Add Product</button>
      <div id="adminStatus"></div>
    </div>

    <!-- Manage Products -->
    <div id="manageProductsSection" style="display:none">
      <h3>Manage Products</h3>
      <div style="overflow:auto;max-height:400px">
        <table id="productsTable">
          <thead>
            <tr><th>Title</th><th>Price</th><th>SKU</th><th>Image</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Orders -->
    <div id="ordersSection" style="display:none">
      <h3>Customer Orders</h3>
      <button id="downloadCSV">Download CSV</button>
      <div style="overflow:auto;max-height:400px;margin-top:10px">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>Name</th><th>Email</th><th>Phone</th><th>Address</th>
              <th>Items</th><th>Total</th><th>Provider</th><th>Status</th><th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <h2>Products</h2>

  <!-- Desktop grid -->
  <div id="productsGrid" class="grid"></div>

  <!-- Mobile two-row sliders -->
  <div class="rows-wrapper">
    <div class="row-container">
      <button class="slider-arrow left">‚Äπ</button>
      <div class="row-slider"><div class="grid-row" id="row1"></div></div>
      <button class="slider-arrow right">‚Ä∫</button>
    </div>

    <div class="row-container">
      <button class="slider-arrow left">‚Äπ</button>
      <div class="row-slider"><div class="grid-row" id="row2"></div></div>
      <button class="slider-arrow right">‚Ä∫</button>
    </div>
  </div>
</div>

<script>
// ===== CONFIG =====
const ADMIN_PIN_HASH = "4d928d91f8095708c95d2e05750a142dc849c84d0897bb9f07605e83a156232f"; 
const API = '/api';
let PRODUCTS = [], cart = JSON.parse(localStorage.getItem('ds_cart') || '[]');
let currentCurrency = "NGN";
let rates = { USD: 1, NGN: 1500 };

async function loadRates() {
  try {
    const res = await fetch("/api/rates");
    const data = await res.json();
    if (data.success) rates = data.rates;
  } catch (e) {
    console.warn("‚ö†Ô∏è Could not load live rates, using fallback.");
  }
}

function convertPrice(usd, currency = currentCurrency) {
  return (usd * (rates[currency] || 1)).toFixed(2);
}

async function sha256(str) {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

(async function(){
  const productsGrid = document.getElementById('productsGrid');
  const cartCount = document.getElementById('cartCount');
  const adminPanel = document.getElementById('adminPanelWrapper');
  const tabAdd = document.getElementById('tabAddProduct');
  const tabManage = document.getElementById('tabManage');
  const tabOrders = document.getElementById('tabOrders');
  const addProductSection = document.getElementById('addProductSection');
  const manageProductsSection = document.getElementById('manageProductsSection');
  const ordersSection = document.getElementById('ordersSection');
  const adminStatus = document.getElementById('adminStatus');
  const ordersTableBody = document.querySelector('#ordersTable tbody');
  const productsTableBody = document.querySelector('#productsTable tbody');

  // ===== ADMIN ACCESS =====
  document.getElementById('adminAccessBtn').addEventListener('click', async () => {
    const pin = prompt("Enter Admin PIN:");
    if (!pin) return;
    const enteredHash = await sha256(pin);
    if (enteredHash === ADMIN_PIN_HASH) {
      adminPanel.style.display = 'block';
      loadOrders();
      loadProductsForAdmin();
    } else {
      alert("‚ùå Wrong PIN");
    }
  });

  document.getElementById('whatsappBtn').addEventListener('click', () => {
    const phone = "2348165881012";
    const url = `https://wa.me/${phone}?text=Hello! I'm interested in your products.`;
    window.open(url, "_blank");
  });

  function showTab(tab){
    addProductSection.style.display = (tab==='add')?'block':'none';
    manageProductsSection.style.display = (tab==='manage')?'block':'none';
    ordersSection.style.display = (tab==='orders')?'block':'none';
    tabAdd.classList.toggle('active', tab==='add');
    tabManage.classList.toggle('active', tab==='manage');
    tabOrders.classList.toggle('active', tab==='orders');
  }
  tabAdd.onclick = ()=>showTab('add');
  tabManage.onclick = ()=>{ showTab('manage'); loadProductsForAdmin(); };
  tabOrders.onclick = ()=>{ showTab('orders'); loadOrders(); };

  document.getElementById('addProductBtn').addEventListener('click', async ()=>{
    const title = adminTitle.value.trim();
    const price = parseFloat(adminPrice.value);
    const supplierCost = parseFloat(adminCost.value);
    const sku = adminSKU.value.trim();
    const img = adminImg.value.trim();

    if(!title || isNaN(price) || isNaN(supplierCost) || !img){
      adminStatus.textContent="‚ö†Ô∏è Missing fields";
      adminStatus.style.color="red"; return;
    }

    const res = await fetch(`${API}/add-product`,{
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({title,price,supplierCost,supplier_sku: sku,img})
    });
    const data = await res.json();
    if(data.success){ 
      adminStatus.textContent="‚úÖ Added"; 
      adminStatus.style.color="green"; 
      loadProducts(); 
      loadProductsForAdmin(); 
    } else { 
      adminStatus.textContent="‚ùå Error "+data.error; 
      adminStatus.style.color="red"; 
    }
  });

  async function deleteProduct(id){
    if(!confirm("Delete this product?")) return;
    const res = await fetch(`${API}/delete-product/${id}`,{method:"DELETE"});
    const data = await res.json();
    if(data.success){ loadProductsForAdmin(); loadProducts(); }
    else alert("Delete failed: "+data.error);
  }
  window.deleteProduct = deleteProduct;

  async function saveProduct(id) {
    const priceInput = document.querySelector(`.edit-price[data-id="${id}"]`);
    const imgInput = document.querySelector(`.edit-img[data-id="${id}"]`);
    const newPrice = parseFloat(priceInput.value);
    const newImg = imgInput.value.trim();

    if (isNaN(newPrice) || !newImg) {
      alert("‚ö†Ô∏è Price or Image URL invalid.");
      return;
    }

    const res = await fetch(`${API}/update-product/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        price: newPrice,
        img: newImg,
        currency: currentCurrency
      })
    });

    const data = await res.json();
    if (data.success) {
      alert("‚úÖ Product updated!");
      loadProductsForAdmin();
      loadProducts();
    } else {
      alert("‚ùå Update failed: " + data.error);
    }
  }
  window.saveProduct = saveProduct;

  async function loadProductsForAdmin() {
    const res = await fetch(`${API}/products`);
    const data = await res.json();
    if (!data.success) return;

    productsTableBody.innerHTML = '';
    data.products.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.title}</td>
        <td>
          ${currentCurrency === "USD"
            ? `<input type="number" value="${p.price_usd}" step="0.01" data-id="${p.id}" class="edit-price" />`
            : `<input type="number" value="${p.price_ngn}" step="0.01" data-id="${p.id}" class="edit-price" />`}
        </td>
        <td>${p.supplier_sku || ''}</td>
        <td>
          <input type="text" value="${p.img}" data-id="${p.id}" class="edit-img" style="width:120px" />
        </td>
        <td>
          <button onclick="saveProduct('${p.id}')"
            style="background:var(--accent);color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer">Save</button>
          <button onclick="deleteProduct('${p.id}')"
            style="background:var(--danger);color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer">Delete</button>
        </td>
      `;
      productsTableBody.appendChild(tr);
    });
  }

  function saveCart(){ localStorage.setItem('ds_cart', JSON.stringify(cart)); updateCartSummary(); }
  function updateCartSummary(){ cartCount.textContent = cart.reduce((sum,i)=>sum+i.quantity,0); }

  async function loadProducts() {
    const res = await fetch(`${API}/products`);
    const data = await res.json();
    if (!data.success) return;

    PRODUCTS = data.products;

    const productsGrid = document.getElementById("productsGrid");
    productsGrid.innerHTML = "";

    const row1 = document.getElementById("row1");
    const row2 = document.getElementById("row2");
    row1.innerHTML = "";
    row2.innerHTML = "";

    PRODUCTS.forEach((p, i) => {
      const cardHTML = `
        <div class="card">
          <img src="${p.img}" alt="${p.title}" onerror="this.src='/placeholder.png'">
          <h4>${p.title}</h4>
          <div class="small">SKU: ${p.supplier_sku || ""}</div>
          <div class="price">
            ${currentCurrency === "USD"
              ? `${p.price_usd.toFixed(2)}`
              : p.price_ngn.toLocaleString("en-NG", { style: "currency", currency: "NGN" })}
          </div>
          <div class="actions">
            <div class="qty-wrapper">
              <label>Qty:</label>
              <input type="number" min="1" value="1" class="qty-input">
            </div>
            <div class="btns">
              <button class="cart-btn add-btn" data-id="${p.id}">Add to Cart</button>
              <button class="cart-btn buy buy-btn" data-id="${p.id}">Buy Now</button>
            </div>
          </div>
        </div>
      `;

      productsGrid.insertAdjacentHTML("beforeend", cardHTML);
      (i % 2 === 0 ? row1 : row2).insertAdjacentHTML("beforeend", cardHTML);
    });

    document.querySelectorAll('.add-btn').forEach(btn => {
      btn.replaceWith(btn.cloneNode(true));
    });
    document.querySelectorAll('.add-btn').forEach(btn => {
      btn.onclick = () => {
        const prod = PRODUCTS.find(x => x.id == btn.dataset.id);
        const qty = Math.max(1, parseInt(btn.closest('.actions').querySelector('.qty-input').value) || 1);
        const ex = cart.find(c => c.id == prod.id);
        if (ex) ex.quantity += qty;
        else cart.push({
          id: prod.id,
          title: prod.title,
          price: currentCurrency === "USD" ? prod.price_usd : prod.price_ngn,
          currency: currentCurrency,
          quantity: qty
        });
        saveCart();
      };
    });

    document.querySelectorAll('.buy-btn').forEach(btn => {
      btn.replaceWith(btn.cloneNode(true));
    });
    document.querySelectorAll('.buy-btn').forEach(btn => {
      btn.onclick = () => {
        const prod = PRODUCTS.find(x => x.id == btn.dataset.id);
        const qty = Math.max(1, parseInt(btn.closest('.actions').querySelector('.qty-input').value) || 1);
        cart = [{
          id: prod.id,
          title: prod.title,
          price: currentCurrency === "USD" ? prod.price_usd : prod.price_ngn,
          currency: currentCurrency,
          quantity: qty
        }];
        saveCart();
        window.location.href = "/checkout.html";
      };
    });

    document.querySelectorAll(".row-container").forEach(container => {
      const rowSlider = container.querySelector(".row-slider");
      const card = rowSlider.querySelector(".card");
      const cardWidth = card ? card.offsetWidth + 16 : 250;

      container.querySelector(".left").onclick = () =>
        rowSlider.scrollBy({ left: -cardWidth, behavior: "smooth" });

      container.querySelector(".right").onclick = () =>
        rowSlider.scrollBy({ left: cardWidth, behavior: "smooth" });
    });
  }

  async function loadOrders(){
    const res = await fetch(`${API}/orders`);
    const data = await res.json();
    if(data.success){ 
      ordersTableBody.innerHTML='';
      data.orders.forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.customer_name||''}</td>
          <td>${o.customer_email||''}</td>
          <td>${o.customer_phone||''}</td>
          <td>${o.customer_address||''}</td>
          <td>${
            Array.isArray(o.items) 
              ? o.items.map(i => `${i.title} (x${i.quantity})`).join(", ") 
              : o.items
          }</td>
          <td>
            ${currentCurrency === "USD"
              ? `${o.total_usd.toFixed(2)}`
              : o.total_ngn.toLocaleString("en-NG", { style: "currency", currency: "NGN" })}
          </td>
          <td>${o.provider}</td>
          <td>${o.status}</td>
          <td>${o.created_at}</td>`;
        ordersTableBody.appendChild(tr);
      });
    }
  }

  document.getElementById("toggleCurrency").addEventListener("click", () => {
    currentCurrency = currentCurrency === "USD" ? "NGN" : "USD";
    loadProducts();
    loadProductsForAdmin();
    loadOrders();
  });

  document.getElementById('downloadCSV').onclick=()=>{
    let csv="Name,Email,Phone,Address,Items,Total,Provider,Status,Date\n";
    document.querySelectorAll('#ordersTable tbody tr').forEach(r=>{
      csv += [...r.children].map(td=>`"${td.innerText}"`).join(",")+"\n";
    });
    const blob = new Blob([csv],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url;a.download="orders.csv";a.click();
    URL.revokeObjectURL(url);
  };

  (async () => {
    await loadRates();
    await loadProducts();
    await loadProductsForAdmin();
    await loadOrders();
    updateCartSummary();
  })();

})();
</script>
</body>
</html>